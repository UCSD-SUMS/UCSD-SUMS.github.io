<!DOCTYPE html>
<html>

	<head>
		<meta charset="utf-8">
		<title>Calendar Test</title>
	</head>

	<body>
		<div id='calendar'></div>
	</body>

	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/fullcalendar/3.4.0/fullcalendar.css" />
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/fullcalendar/3.4.0/fullcalendar.print.css" media='print' />
	<style type="text/css">
body {
	margin-top: 40px;
	text-align: center;
	font-size: 14px;
	font-family: "Lucida Grande", Helvetica, Arial, Verdana, sans-serif;
}

#calendar {
	width: 900px;
	margin: 0 auto;
}

	</style>

	<script type="text/javascript" src="//ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.18.1/moment.min.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/fullcalendar/3.4.0/fullcalendar.js"></script>
	<script src="ical.js"></script>

	<script>
Date.prototype.addHours = function(h) {
	this.setHours(this.getHours() + h);
	return this;
}
const now = new Date();

const initCalendar = (events) => {
	$('#calendar').fullCalendar({
		header: {
			left: 'prev,next today',
			center: 'title',
			right: 'month,agendaWeek'
		},
		defaultDate: now,
		defaultView: 'month',
		selectable: false,
		editable: false,
		events: events
	});
};

$.ajax({
	type: 'GET',
	url: '/events.ics',
	success: (result) => {
		const eventData = new ICAL.Component(
			ICAL.parse(result)
		).getAllSubcomponents();

		const events = eventData.map(a => {
			return {
				title: a.getFirstPropertyValue('summary'),
				start: a.getFirstPropertyValue('dtstart').toJSDate(),
				end: a.hasProperty('dtend') ?
					a.getFirstPropertyValue('dtend').toJSDate() : a.getFirstPropertyValue('dtstart').toJSDate().addHours(1),
				url: a.getFirstPropertyValue('url')
			}
		});

		initCalendar(events);
	}
});

	</script>

</html>
